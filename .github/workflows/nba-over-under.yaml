name: build-nba-webpage
on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - .github/workflows/nba-over-under.yaml
jobs:
  check-date:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.date_check.outputs.should_run }}
    steps:
      - id: date_check
        run: |
          CURRENT_DATE=$(date -u +%Y-%m-%d)
          CUTOFF_DATE="2026-04-15"
          if [[ "$CURRENT_DATE" < "$CUTOFF_DATE" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi
  build-nba-webpage:
    runs-on: ubuntu-latest
    needs: check-date
    if: ${{ needs.check-date.outputs.should_run == 'true' }}
    env:
      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev
          
      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          
      - uses: r-lib/actions/setup-pandoc@v2
      
      - name: Install dependencies
        run: |
          install.packages("pak", repos = sprintf("https://r-lib.github.io/p/pak/stable/%s/%s/%s", .Platform$pkgType, R.Version()$os, R.Version()$arch))
          pak::pak(c(
            "remotes",
            "rmarkdown",
            "quarto",
            "httr",
            "jsonlite",
            "tidyverse",
            "magrittr",
            "curl",
            "memoise",
            "furrr",
            "future",
            "glue",
            "stringi",
            "rvest",
            "DT",
            "htmltools",
            "reticulate"
          ), upgrade = FALSE)
        shell: Rscript {0}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache reticulate Python environment
        uses: actions/cache@v4
        with:
          path: /home/runner/.virtualenvs/r-reticulate
          key: ${{ runner.os }}-reticulate-py3.11-pandas-nba_api-v1
      
      - name: Install Python packages for reticulate
        run: |
          Rscript -e "reticulate::virtualenv_create('r-reticulate', python = Sys.which('python'))"
          Rscript -e "reticulate::virtualenv_install('r-reticulate', c('pandas', 'nba_api'))"
      
      - name: Build webpage
        run: |
          Rscript nba-over-under-2025-2026/make_plot_html.R
      
      - name: Push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add -A
          git commit -m "GitHub Actions NBA page build" || echo "No changes to commit"
          git push origin master
          
      - name: Session info
        run: |
          Rscript -e "sessioninfo::session_info()"