name: Deploy Shiny Apps

on:
  schedule:
  #   - cron: "*/10 * * * *"
    - cron: "0 13 * * *"
  # push:
  #  branches: [ main, master ]
  workflow_dispatch:

jobs:
  shiny-deploy:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Install system libraries
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libfontconfig1-dev \
            libfreetype6-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libpng-dev \
            libtiff-dev \
            libjpeg-dev \
            libwebp-dev \
            zlib1g-dev \
            libbz2-dev \
            imagemagick \
            libmagick++-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libpoppler-cpp-dev

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.1'
          use-public-rspm: true

      - name: Setup renv
        uses: r-lib/actions/setup-renv@v2

      - name: Write .renvignore
        shell: bash
        run: |
          cat > .renvignore <<'EOF'
          ^nba-over-under-2020-2021/rds$
          ^nba-over-under-2021-2022/rds$
          ^nba-over-under-2022-2023/rds$
          ^nba-over-under-2023-2024/rds$
          ^nba-over-under-2024-2025/rds$
          ^.*\.rds$
          EOF

      - name: Install Quarto
        shell: bash
        run: |
          set -euxo pipefail
          wget https://github.com/quarto-dev/quarto-cli/releases/download/v1.8.25/quarto-1.8.25-linux-amd64.deb
          sudo dpkg -i quarto-1.8.25-linux-amd64.deb

      - name: Install rsconnect
        shell: bash
        run: Rscript -e 'renv::install("rsconnect")'

      # - name: Authorize and deploy player finder app
      #   continue-on-error: true
      #   env:
      #     APPNAME: nba-player-finder
      #     ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
      #     SERVER: shinyapps.io
      #   shell: bash
      #   run: |
      #     set -euxo pipefail
      #     Rscript -e 'rsconnect::setAccountInfo("${{ secrets.SHINYAPPS_ACCOUNT }}", "${{ secrets.SHINYAPPS_TOKEN }}", "${{ secrets.SHINYAPPS_SECRET }}")' \
      #             -e 'renv::restore(prompt = FALSE)' \
      #             -e 'rsconnect::deployApp(appDir = "nba-over-under-2025-2026/rosters", appName = "${{ env.APPNAME }}", account = "${{ env.ACCOUNT }}", server = "${{ env.SERVER }}", quarto = FALSE)'

      - name: Authorize and deploy points calculator app
        continue-on-error: true
        env:
          APPNAME: over-under-points-calculator
          ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
          SERVER: shinyapps.io
        shell: bash
        run: |
          set -euxo pipefail
          Rscript -e 'rsconnect::setAccountInfo("${{ secrets.SHINYAPPS_ACCOUNT }}", "${{ secrets.SHINYAPPS_TOKEN }}", "${{ secrets.SHINYAPPS_SECRET }}")' \
                  -e 'renv::restore(prompt = FALSE)' \
                  -e 'rsconnect::deployApp(appDir = "nba-over-under-2025-2026/over-under-points-calculator", appName = "${{ env.APPNAME }}", account = "${{ env.ACCOUNT }}", server = "${{ env.SERVER }}", quarto = FALSE)'

      # Example third app
      # - name: Authorize and deploy fantasy draft app
      #   continue-on-error: true
      #   env:
      #     APPNAME: fantasy-draft
      #     ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
      #     SERVER: shinyapps.io
      #   shell: bash
      #   run: |
      #     set -euxo pipefail
      #     Rscript -e 'rsconnect::setAccountInfo("${{ secrets.SHINYAPPS_ACCOUNT }}", "${{ secrets.SHINYAPPS_TOKEN }}", "${{ secrets.SHINYAPPS_SECRET }}")' \
      #             -e 'renv::restore(prompt = FALSE)' \
      #             -e 'rsconnect::deployApp(appDir = "nba-over-under-2025-2026/fantasy-draft", appName = "${{ env.APPNAME }}", account = "${{ env.ACCOUNT }}", server = "${{ env.SERVER }}", quarto = FALSE)'
